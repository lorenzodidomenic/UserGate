<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy</title>
    <link rel="stylesheet" href="./assets/css/styleIndex.css">
</head>
<body>
    

    <div id="intro">
        <h1> Pagina Query </h1>
    </div>
    


    <div id="searchContainer">
        <input type="text" id="queryInput" placheholder="Inserisci Filtro"> <button class="button">Bottone ricerca</button>

        <div id="filterContainer">
            <div id="row"><span> Base </span> <input type="text" id="filterBase" placeholder="Base ricerca" value="dc=unict,dc=ad"> <br> </div>
            <div id="row"><span> Nome </span> <input type="text" id="filterName" placeholder="Nome utente"> <br> </div>
            <div id="row"> <span> Cognome </span> <input type="text" id="filterSurname" placeholder="Cognome utente"> <br> </div>
            <div id="row"> <span> Codice Fiscale </span> <input type="text" id="filtercf" placeholder="Codice Fiscale utente"> <br> </div>
            <div id="row"> <span> Gruppo d'appartenenza </span> <input type="text" id="filterGroup" placeholder="Gruppo utente"> <br> </div>
            <button id="filterButton">Crea Filtro</button>
            <button id="filterClearButton">Pulisci Filtro</button>
        </div>
    </div>

    <div id="container">
    </div>

    <div id="containerUserInfo">

    </div>
 
    <script src="index.js"></script>
</body>
</html>




window.onload= ()=>{

    btn = document.getElementsByClassName("button")
    container = document.getElementById("container")
    searchContainer = document.getElementById("searchContainer")
    queryInput = document.getElementById("queryInput")
    containerUserInfo=document.getElementById("containerUserInfo")
    filterName = document.getElementById("filterName")
    filterSurname = document.getElementById("filterSurname")
    filterCf = document.getElementById("filtercf")
    filterGroup = document.getElementById("filterGroup")
    filterButton = document.getElementById("filterButton")
    filterClearButton = document.getElementById("filterClearButton")
    


    async function f(){


        /* prendo il contenuto del form e  lo metto come parametro della query */

        query = this.queryInput.value

        /*qui dovrei sostituire & se è presente con %26*/
        query = query.replace("&","%26")

        response = await fetch("http://localhost:8083/search?query="+query);
       
        response_mex = await response.json()

        return response_mex;
    }

    btn[0].addEventListener("click", async ()=>{
        
                response =  await f();

                this.container.innerHTML = ""

                console.log(response.length)
                if(response.length == 0){
                mex = document.createElement("div")
                mex.classList = ["entryRow"]
                mex.innerHTML = "Nessun Utente Esistente";
                container.appendChild(mex)

                this.containerUserInfo.style.display = "none"
                this.container.style.display = "block"
                }else{
                for(let i = 0; i<response.length; i++){
                mex = document.createElement("div")
                mex.classList = ["entryRow"]
                mex.setAttribute("id",response[i]["cn"])
                mex.innerHTML = response[i]["sn"] + " &nbsp" + response[i]["givenName"] + " &nbsp" + response[i]["cn"];
                container.appendChild(mex)

                this.containerUserInfo.style.display = "none"
                this.container.style.display = "block"


                mex.addEventListener("click",async ()=>{
                    console.log("utente selezionato: ", event.target.getAttribute("id"))

                    cn = event.target.getAttribute("id")

                    //devo fare la query con cn quell'id
                    query = "cn="+event.target.getAttribute("id")

                    response = await fetch("http://localhost:8083/searchUser?query="+query);
                    
                    response_mex = await response.json();

                    console.log(response_mex)
                    
                    this.containerUserInfo.innerHTML = ""
                    for(let i = 0; i< response_mex.length; i++){
                        mex = document.createElement("div")
                        mex.classList = ["entryRow"]
                        if(response_mex[i].type == "cn")
                        mex.setAttribute("id",response_mex[i].value)

                        //se il response_mex[i].type = member of metto a capo
                        mex.innerHTML = "<span>"+response_mex[i].type + ":"

                        if(response_mex[i].type == "MEMBEROFGROUP"){
                            //mex.innerHTML = mex.innerHTML + "<br>"
                            for(let j = 0; j< response_mex[i].value.length; j++){
                                if(j != response_mex[i].value.length-1)
                                mex.innerHTML = mex.innerHTML + response_mex[i].value[j] + "<br> MEMBEROFGROUP: "
                                else
                                mex.innerHTML = mex.innerHTML + response_mex[i].value[j] 
                            }
                        }else{
                            mex.innerHTML = "<span>"+response_mex[i].type + ":"+ response_mex[i].value 
                        }
                       mex.innerHTML = mex.innerHTML +  "</span>"//+ "<div> <button id='modifyBtn' type='"+response_mex[i].type+"'><img src='./assets/images/pencil.png'></button> <button id='deleteBtn' ><img src='./assets/images/bin.png'></button> </div>" 

                        /* dovrei creare bottone, metterlo come figlio della riga e settargli gli attributi che mi servono per la modifica
                        buttonSection = document.createElement("div")
                        buttonMod = document.createElement("button")
                        buttonMod.setAttribute("id","modifyBtn")
                        buttonMod.setAttribute("type",response_mex[i].type)
*/
                        this.containerUserInfo.appendChild(mex)
                    }
                    
                    
                    container.style.display = "none"
                    buttonSection = document.createElement("div")
                    buttonSection.style.textAlign = "center" 
                    buttonMod = document.createElement("button")
                    buttonMod.innerHTML = "<img src='./assets/images/pencil.png'>"
                    buttonMod.setAttribute("id","modifyBtn")
                    buttonMod.setAttribute("cn",cn)

                    //al click su questo bottone mi porta su un altra pagina che contiene dettagli utente modificabili
                    buttonMod.addEventListener("click", async ()=>{
                       // await fetch("http://localhost:8083/modifyUser");
                       location.href = "http://localhost:8083/modifyUser?cn="+cn
                    })
                    buttonSection.appendChild(buttonMod)
                    this.containerUserInfo.appendChild(buttonSection)

                    this.containerUserInfo.style.display = "block"

                    this.queryInput.value = ""
                    /*
                    container.style.display = "none"

                    this.containerUserInfo.innerHTML = ""
                    userInfo = document.createElement("div")

                    userInfo.innerHTML = response_mex

                    containerUserInfo.appendChild(userInfo)

                    
                    */
                })
                }
            }
    }
)

this.filterButton.addEventListener("click",()=>{


    /* vado a riempire l'input del filtro per poi poter fare la query */

    //mi prendo l'input dei vari campi e se non è nullo vado a creare il filtro

    another = false;

    nameText = this.filterName.value;
    surnameText = this.filterSurname.value;
    cfText = this.filterCf.value;
    groupText = this.filterGroup.value;

    stringQuery = "";
    queryText = "";
    if((nameText != null) && (nameText!="")){
        stringQuery = "(givenName="+nameText+")"
        another = true;
    }

    if((surnameText!=null)&&(surnameText!="")){
        if(another){
            stringQuery = "(&(sn="+surnameText+")"+stringQuery+")"
        }
        else{
            stringQuery = "sn="+surnameText+""
        }
    }

    if((cfText != null)&&(cfText!="")){
        if(another){
            stringQuery = "(&(cn="+cfText+")"+stringQuery+")"
        }
        else{
            stringQuery = "cn="+cfText+""
        }
    }

    if((groupText != null) && (groupText != "")){
        if(another){
            stringQuery = "(&(memberof= cn="+groupText+",ou=Gruppi studenti,dc=unict,dc=ad)"+stringQuery+")"
        }
        else{
            stringQuery = "memberOf= cn="+groupText+",ou=Gruppi studenti,dc=unict,dc=ad"
        }
    }

    this.queryInput.value = stringQuery

    this.filterName.value = ""
    this.filterSurname.value = ""
    this.filterCf.value = ""
    this.filterGroup.value = ""

})


this.filterClearButton.addEventListener("click",()=>{
    this.queryInput.value = ""
})
}

